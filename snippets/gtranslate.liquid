<!-- snippets/language-switcher.liquid -->
<style>
  .language-switcher {
    position: relative;
    display: inline-block;
    font-family: Arial, sans-serif;
  }
  .language-switcher button {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
  }
  .language-switcher button img {
    margin-right: 8px;
    width: 16px;
    height: 16px;
  }
  .language-switcher ul {
    list-style: none;
    margin: 4px 0 0;
    padding: 0;
    position: absolute;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
  }
  .language-switcher li {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    cursor: pointer;
  }
  .language-switcher li:hover {
    background: #f5f5f5;
  }
  .language-switcher li img {
    margin-right: 8px;
    width: 16px;
    height: 16px;
  }
</style>

<div class="language-switcher" id="language-switcher">
  <button aria-haspopup="listbox" aria-expanded="false" id="lang-toggle">
    <img src="//cdn.gtranslate.net/shopify/assets/flags/16/en.png" alt="English flag" />
    <span id="lang-label">English</span>
  </button>
  <ul role="listbox" id="lang-list" hidden>
    <li role="option" data-lang="en"><img src="//cdn.gtranslate.net/shopify/assets/flags/16/en.png" alt="English flag" /> English</li>
    <li role="option" data-lang="ar"><img src="//cdn.gtranslate.net/shopify/assets/flags/16/ar.png" alt="Arabic flag" /> Arabic</li>
    <li role="option" data-lang="es"><img src="//cdn.gtranslate.net/shopify/assets/flags/16/es.png" alt="Spanish flag" /> Spanish</li>
    <li role="option" data-lang="fr"><img src="//cdn.gtranslate.net/shopify/assets/flags/16/fr.png" alt="French flag" /> French</li>
    <!-- Add more languages here -->
  </ul>
</div>

<!-- Hidden container for Google Translate widget -->
<div id="google_translate_element2" style="display:none"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('lang-toggle');
    const listbox = document.getElementById('lang-list');
    const label = document.getElementById('lang-label');
    let gtranslateLoaded = false;

    function loadGTranslate() {
      if (gtranslateLoaded) return;
      gtranslateLoaded = true;
      // Load Google Translate element script
      const el = document.createElement('script');
      el.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit2';
      el.defer = true;
      document.head.appendChild(el);
      // Load GTranslate float.js for doGTranslate
      const floatJs = document.createElement('script');
      floatJs.src = '//cdn.gtranslate.net/widgets/latest/float.js';
      floatJs.async = true;
      document.head.appendChild(floatJs);

      // Callback to initialize widget
      window.googleTranslateElementInit2 = function() {
        new google.translate.TranslateElement({pageLanguage: 'en', autoDisplay: false}, 'google_translate_element2');
      };
    }

    toggleBtn.addEventListener('click', () => {
      const open = listbox.hidden;
      toggleBtn.setAttribute('aria-expanded', String(open));
      listbox.hidden = !open;
      if (open) loadGTranslate();
    });

    listbox.addEventListener('click', (e) => {
      const opt = e.target.closest('li[role="option"]');
      if (!opt) return;
      const lang = opt.getAttribute('data-lang');
      // Update button label and flag
      label.textContent = opt.textContent.trim();
      const img = opt.querySelector('img').cloneNode(true);
      toggleBtn.querySelector('img').replaceWith(img);
      // Close dropdown
      listbox.hidden = true;
      toggleBtn.setAttribute('aria-expanded', 'false');
      // Perform translation (always from English)
      if (typeof doGTranslate === 'function') {
        doGTranslate('en|' + lang);
      } else {
        console.error('Translation function not available.');
      }
    });

    document.addEventListener('click', (e) => {
      if (!document.getElementById('language-switcher').contains(e.target)) {
        listbox.hidden = true;
        toggleBtn.setAttribute('aria-expanded', 'false');
      }
    });
  });
</script>
