<script>
document.addEventListener('DOMContentLoaded', function () {
  const utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];
  const urlParams = new URLSearchParams(window.location.search);
  const hasUtmParams = utmParams.some(param => urlParams.has(param));

  // UTM storage
  function deleteUTMFromLocalStorage(param) {
    localStorage.removeItem(param);
  }
  function setUTMInLocalStorage(param, value) {
    localStorage.setItem(param, value);
    sessionStorage.setItem(param, value);
  }

  // Store or clear UTM
  if (hasUtmParams) {
    utmParams.forEach(param => {
      deleteUTMFromLocalStorage(param);
      if (urlParams.has(param)) {
        setUTMInLocalStorage(param, urlParams.get(param));
      }
    });
  } else {
    utmParams.forEach(param => deleteUTMFromLocalStorage(param));
  }

  // Get stored UTM
  const storedUtmParams = utmParams.reduce((acc, param) => {
    const value = localStorage.getItem(param);
    if (value) acc[param] = value;
    return acc;
  }, {});

  // Function to update links with UTM
  function updateLinksWithUTM(container = document) {
    if (Object.keys(storedUtmParams).length === 0) return;

    const links = container.querySelectorAll('a[href]');
    links.forEach(link => {
      if (link.getAttribute('href') !== '#menu') {
        try {
          const url = new URL(link.href, window.location.origin);
          Object.entries(storedUtmParams).forEach(([key, value]) => {
            url.searchParams.set(key, value);
          });
          link.href = url.toString();
        } catch (e) {}
      }
    });

    const dataLinks = container.querySelectorAll('[data-link]');
    dataLinks.forEach(el => {
      try {
        const url = new URL(el.getAttribute('data-link'), window.location.origin);
        Object.entries(storedUtmParams).forEach(([key, value]) => {
          url.searchParams.set(key, value);
        });
        el.setAttribute('data-link', url.pathname + url.search);
      } catch (e) {}
    });

    const wrappers = container.querySelectorAll('.image-link-wrapper[data-link]');
    wrappers.forEach(wrapper => {
      const link = wrapper.getAttribute('data-link');
      wrapper.addEventListener('click', function () {
        window.location.href = link;
      });
    });
  }

  updateLinksWithUTM();


  const observer = new MutationObserver((mutationsList) => {
    mutationsList.forEach(mutation => {
      mutation.addedNodes.forEach(node => {
        if (node.nodeType === 1) {
          if (node.matches('.mega-menu__list') || node.querySelector('.mega-menu__list'))
           {
            updateLinksWithUTM(node);
          }
        }
      });
    });
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
});

</script>  