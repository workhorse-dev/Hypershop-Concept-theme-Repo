{%- comment -%}
  Renders a product card

  Accepts:
  - product: {Object} Product Liquid object (optional)
  - lazy_load: {Boolean} Image should be lazy loaded. Default: true (optional)
  - image_ratio: {String} Size of the product image card. Values are "square", "landscape" and "portrait". Default is "square" (optional)
  - image_fill: {Boolean} Zoom image to fill space. Default: false (optional)
  - show_secondary_image: {Boolean} Show the secondary image on hover. Default: false (optional)
  - show_vendor: {Boolean} Show the product vendor. Default: false
  - show_rating: {Boolean} Show the product rating. Default: false
  - show_countdown: {Boolean} Show the countdown timer.
  - show_quick_add: {Boolean} Show the quick add button.
  - show_quick_view: {Boolean} Show the quick view button.
  - show_color_swatches: {Boolean} Show the color swatches.
  - show_save_amount: {Boolean} Show save amount.
  - amount_type: {String} Save amount type.
  - show_variant_labels: {Boolean} Show the variant label.
  - picker_type: {String} Variant picker type.
  - enable_color_swatches: {Boolean} Enable the color swatches.
  - color_swatch_type: {String} Color swatch type.
  - product_id: {String} The ID of the current product.
  - section_id: {String} The ID of the section that contains this card.

  Usage:
  {% render 'product-card-bundle', show_vendor: section.settings.show_vendor %}
{%- endcomment -%}

{%- if product != blank -%}
  {%- liquid
    assign product_variant = product.selected_or_first_available_variant
    assign featured_media = product_variant.featured_image | default: product.featured_image
    assign media_count = 0

    if product.has_only_default_variant
      assign product_media = product.media
      assign media_count = product_media.size
    endif

    if product_variant.metafields.theme.gang_media.value != blank and product_variant.metafields.theme.gang_media.list?
      assign product_media = product_variant.metafields.theme.gang_media.value
      assign media_count = product_media.count
    endif

    assign product_url = product.url | within: collection
    if settings.product_disable_collection_portion
      assign product_url = product.url
    endif
  -%}
  <div class="card product-card product-card--{{ settings.card_style }}{% if settings.card_border_thickness > 0 %} product-card--thickness{% endif %}{% unless featured_media %} no-media{% endunless %} flex flex-col leading-none relative">
    {%- if featured_media -%}
      <div class="product-card__media relative h-auto">
        {%- if show_quick_view -%}
          {%- capture quick_view_id -%}Quickview-{{ section_id }}-{{ product_id }}{%- endcapture -%}
          <button type="button" class="quick-view__button button button--secondary z-2 absolute top-0 right-0 opacity-0" is="hover-button" aria-controls="{{ quick_view_id }}" aria-expanded="false">
            <span class="btn-fill" data-fill></span>
            <span class="btn-text">
              {%- render 'icon', icon: 'eye', size: 'sm' -%}
              <span class="sr-only">{{ 'products.product.quick_view' | t }}</span>
            </span>
          </button>
          <quick-view id="{{ quick_view_id }}" class="quick-view x-modal drawer z-40 fixed bottom-0 left-0 h-full w-full pointer-events-none" data-product-url="{{ product_url }}" role="dialog" aria-label="{{ 'products.product.choose_product_options' | t: product_name: product.title | escape }}" aria-modal="true" hidden>
            <overlay-element class="overlay fixed-modal invisible opacity-0 fixed bottom-0 left-0 w-full h-screen pointer-events-none" aria-controls="{{ quick_view_id }}" aria-expanded="false"></overlay-element>
            <div class="drawer__inner z-10 absolute top-0 flex flex-col w-full h-full overflow-hidden">
              <gesture-element class="drawer__header flex justify-between opacity-0 invisible relative">
                <button class="button button--secondary button--close drawer__close z-1 absolute top-0 right-0 flex items-center justify-center opacity-0" type="button" is="hover-button" aria-controls="{{ quick_view_id }}" aria-expanded="false" aria-label="{{ 'general.accessibility.close' | t | escape }}">
                  <span class="btn-fill" data-fill></span>
                  <span class="btn-text">
                    {%- render 'icon', icon: 'close', size: 'sm' -%}
                  </span>
                </button>
              </gesture-element>
              <div class="quick-view__content drawer__content opacity-0 invisible flex flex-col h-full grow shrink"></div>
            </div>
          </quick-view>
        {%- endif -%}

        {%- if show_rating -%}
          {%- liquid
            assign rating_max = 5
          
            if product.metafields.reviews.rating.value != blank and product.metafields.reviews.rating_count.value > 0
              assign rating_value = product.metafields.reviews.rating.value.rating | round: 1
              assign rating_count = product.metafields.reviews.rating_count.value
              assign rating_max = product.metafields.reviews.rating.value.scale_max
            elsif show_empty
              assign rating_value = 0.0
              assign rating_count = 0
            elsif show_placeholder
              assign rating_value = 4.5
              assign rating_count = 2
            else
              assign hide_rating = true
            endif
          -%}
          
          {%- unless hide_rating -%}
            <div class="rating product-card__rating z-2 absolute rounded-full flex items-center gap-2 md:gap-1d5 pointer-events-none" title="{{ 'general.accessibility.star_reviews_count' | t: count: rating_count | escape }}">
              <span role="img" aria-label="{{ 'general.accessibility.star_reviews_info' | t: rating_value: rating_value, rating_max: rating_max }}">
                {%- render 'icon', icon: 'star', size: 'xs' -%}
              </span>
              {%- liquid
                if display_mode == 'count'
                  echo 'general.accessibility.star_reviews_count' | t: count: rating_count
                else
                  echo rating_value
                endif
              -%}
            </div>
          {%- endunless -%}
        {%- endif -%}

        {%- render 'product-badges', product: product, show_save_amount: show_save_amount, save_type: save_type, class: 'z-2 absolute grid gap-3' -%}

        <a id="ProductGallery-{{ section_id }}-{{ product_id }}" class="block relative media media--{{ image_ratio }}{% unless image_fill %} media--contain{% endunless %}{% unless show_secondary_image and media_count > 1 %} overflow-hidden{% endunless %}" href="{{ product_url }}" aria-label="{{ product.title | escape }}" tabindex="-1">
          {%- unless featured_media.media_type == 'video' or featured_media.media_type == 'external_video' -%}
            {%- if show_secondary_image and media_count > 1 -%}
              <template>
                {%- for media in product_media limit: 4 -%}
                  <div class="media media--height{% unless image_fill %} media--contain{% endunless %} w-full h-full overflow-hidden">
                    {{- media | image_url: width: media.width | image_tag: loading: 'lazy', widths: '180,360,540,720,900,1080', is: 'lazy-image' -}}
                  </div>
                {%- endfor -%}
              </template>
              <secondary-media class="product-card__carousel block absolute top-0 left-0 w-full h-full hidden md:block"></secondary-media>
            {%- endif -%}

            {{- featured_media | image_url: width: featured_media.width | image_tag: loading: 'lazy', widths: '180,360,540,720,900,1080', is: 'lazy-image' -}}
          {%- else -%}
            {%- render 'product-video',
              video: featured_media,
              muted: false,
              autoplay: false,
              loop: false,
              cover_image: featured_media,
              show_play_button: true,
              class: 'relative w-full overflow-hidden'
            -%}
          {%- endunless -%}
        </a>
         {%- unless product.has_only_default_variant -%}
          <variant-selects id="VariantPicker-{{ section_id }}-{{ product_id }}" class="variant-picker grid gap-5 no-js-hidden options-scroll-variant-css">
            {%- for option in product.options_with_values -%}
              {%- if picker_type == 'button' -%}
                {%- liquid
                  assign is_color = false
                  if enable_color_swatches
                    assign swatch_file_extension = 'png'
                    assign swatch_trigger_list = 'products.general.color_swatch_trigger' | t | downcase | split: ','
                    assign downcased_option = option.name | downcase
                    for trigger in swatch_trigger_list
                      assign swatch_trigger = trigger | strip
                      if downcased_option contains swatch_trigger
                        assign is_color = true
                      elsif swatch_trigger == 'color' and downcased_option contains 'colour'
                        assign is_color = true
                      endif

                      if is_color == true
                        break
                      endif
                    endfor
                  endif

                  assign option_index_0 = forloop.index0
                -%}
                <fieldset class="js product-form__input variant-input-wrapper relative"
                  data-option-index="option{{ forloop.index }}"
                  data-option-slug="{{ option.name | handleize }}"
                >
                  <legend class="sr-only">{{ option.name }}</legend>
                  {% comment %} <div class="form__label flex items-center justify-between gap-2 w-full">
                    {%- if show_variant_labels -%}
                      <div class="flex gap-2">
                        {{- option.name -}}:
                        <span class="font-medium" id="{{ section_id }}-{{ product_id }}-option{{ option.position }}">{{ option.selected_value }}</span>
                      </div>
                    {%- endif -%}
                  </div> {% endcomment %}
                  <scroll-shadow class="product-card__bottom grid w-full">
                    <ul class="options-scroll scroll-area swatches swatches--{{ settings.rounded_swatch }}{% if color_swatch_type == 'variant' %} swatches--variant{% endif %} grid justify-start gap-4">
                      {%- for value in option.values -%}
                        <li>
                          <magnet-element class="block">
                            <input
                              type="radio"
                              class="sr-only{% unless value.available %} disabled{% endunless %}"
                              id="{{ section_id }}-{{ product_id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                              name="{{ option.name }}-{{ section_id }}-{{ product_id }}"
                              value="{{ value | escape }}"
                              {% unless value.available %}disabled{% endunless %}
                              {% if option.selected_value == value %}checked{% endif %}
                              {% if value.product_url != blank and value.product_url != product.url %}data-product-url="{{ value.variant.url | default: value.product_url }}"{% endif %}
                              data-option-value="{{ value | escape }}"
                              data-option-value-id="{{ value.id }}"
                              align-selected=".scroll-area"
                            />
                            {%- if is_color or value.swatch != blank -%}
                              {%- liquid
                                if value.swatch == blank
                                  assign file_extension = swatch_file_extension | default: 'png'
                                  assign file_name = value | handle | append: '.' | append: file_extension
                                  assign swatch_fallback = value | split: ' ' | last | handle
                                  assign swatch_fallback_override = false

                                  if settings.swatch_config != blank
                                    assign value_downcase = value | downcase
                                    assign swatch_config = settings.swatch_config | newline_to_br | split: '<br />'
                                    for swatch in swatch_config
                                      assign swatch_parts = swatch | strip | split: ':'
                                      assign swatch_name = swatch_parts.first | downcase | strip

                                      if swatch_name == value_downcase
                                        assign swatch_value = swatch_parts.last | strip
                                        if swatch_value contains '#'
                                          assign swatch_fallback = swatch_value
                                          assign swatch_fallback_override = true
                                        else
                                          assign file_name = swatch_value
                                        endif
                                        break
                                      endif
                                    endfor
                                  endif

                                  assign swatch_image = blank
                                  if images[file_name] != blank
                                    assign swatch_image = images[file_name] | image_url: width: 72
                                  elsif file_name contains '//cdn.shopify.com/'
                                    assign swatch_image = file_name
                                  endif
                                else
                                  assign swatch_image = blank
                                  assign swatch_fallback = value | split: ' ' | last | handle
                                  if value.swatch.image
                                    assign swatch_image = value.swatch.image | image_url: width: 72
                                    assign swatch_fallback_override = false
                                  elsif value.swatch.color
                                    assign swatch_fallback = value.swatch.color
                                  endif
                                endif

                                if color_swatch_type == 'variant'
                                  for variant in product.variants
                                    assign variant_value = variant.options[option_index_0]
                                    if variant_value contains value and variant.image
                                      assign swatch_image = variant.image | image_url: width: 72
                                      assign swatch_fallback_override = false
                                      break
                                    endif
                                  endfor
                                endif
                              -%}
                              <label
                                for="{{ section_id }}-{{ product_id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                                class="color-swatch{% if swatch_image != blank %} with-image{% endif %} relative"
                                title="{{ value | escape }}"
                                style="--swatch-background: {{ swatch_fallback }};{% if swatch_fallback_override == false and swatch_image != blank %} --swatch-background-image: url({{ swatch_image }});{% endif %}"
                              >
                                <span class="sr-only">{{ value | escape }}</span>
                              </label>
                            {%- else -%}
                              <label
                                for="{{ section_id }}-{{ product_id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                                class="label-swatch text-sm font-medium leading-none cursor-pointer relative"
                                title="{{ value | escape }}"
                              >
                                {{- value -}}
                              </label>
                            {%- endif -%}
                          </magnet-element>
                        </li>
                      {%- endfor -%}
                    </ul>
                    <template>
                      <slot></slot>
                      <s dir="{% render 'direction' %}" style="--t: 0; --b: 0; --l: 0; --r: 0;">
                        <span class="l"></span>
                        <span class="r"></span>
                      </s>
                      <style>
                        :host{display:inline-block;position:relative}:host([hidden]){display:none}
                        s{position:absolute;inset:0;pointer-events:none;}
                        s span{position:absolute;inset-block:0;width:var(--sp-12);opacity:0;transition:opacity var(--animation-short);}
                        s .l{inset-inline-start:0;opacity:var(--l);background:linear-gradient(90deg,rgb(var(--color-background)) 0%,transparent 100%);}
                        s .r{inset-inline-end:0;opacity:var(--r);background:linear-gradient(270deg,rgb(var(--color-background)) 0%,transparent 100%);}
                        s[dir=rtl] :is(.icon-chevron-left,.icon-chevron-right){transform:scaleX(-1);}
                      </style>
                    </template>
                  </scroll-shadow>
                </fieldset>
              {%- else -%}
                <div class="product-form__input product-form__input--dropdown variant-input-wrapper"
                  data-option-index="option{{ forloop.index }}"
                  data-option-slug="{{ option.name | handleize }}"
                >
                  <div class="form__label flex items-center justify-between gap-2 w-full">
                    {%- if show_variant_labels -%}
                      <label class="flex gap-2" for="Option-{{ section_id }}-{{ product_id }}-{{ forloop.index0 }}">
                        {{- option.name -}}
                      </label>
                    {%- endif -%}
                  </div>
                  <div class="field">
                    <select id="Option-{{ section_id }}-{{ product_id }}-{{ forloop.index0 }}"
                      class="select"
                      name="options[{{ option.name | escape }}]"
                      is="custom-select"
                    >
                      {%- for value in option.values -%}
                        <option value="{{ value | escape }}" data-option-value-id="{{ value.id }}" {% if option.selected_value == value %}selected{% endif %}{% if value.product_url != blank and value.product_url != product.url %} data-product-url="{{ value.variant.url | default: value.product_url }}"{% endif %}>
                          {{ value }}
                        </option>
                      {%- endfor -%}
                    </select>
                    {%- render 'icon', icon: 'chevron-up', size: 'sm', class: 'absolute' -%}
                  </div>
                </div>
              {% endif %}
            {%- endfor -%}

            <script type="application/json" data-selected-variant>{{ product.selected_or_first_available_variant | json }}</script>
          </variant-selects>
        {%- else -%}
    
    <script type="application/json" data-selected-variant>{{ product.selected_or_first_available_variant | json }}</script>
     
  {%- endunless -%}

        {%- if show_countdown and product.metafields.theme.countdown.value != blank -%}
          {%- liquid
            assign now_time = 'now' | date: '%s' | times: 1
            assign countdown_time = product.metafields.theme.countdown.value | date: '%s' | times: 1
          -%}
          {%- if countdown_time > now_time -%}
            <div class="product-card__countdown hidden sm:flex justify-center absolute w-full z-0 pointer-events-none no-js-hidden">
              <div class="button icon-with-text">
                <div class="btn-text">
                  {%- render 'icon', icon: 'countdown-compact', size: 'sm', class: 'shrink-0 hidden md:block' -%}
                  <countdown-timer
                    class="flex gap-3"
                    data-expires="{{ product.metafields.theme.countdown.value | date: '%FT%T%:z' | escape }}"
                    data-compact="true"
                  >
                    <div class="countdown__item">
                      <p>--{{ 'general.date.d' | t }}</p>
                    </div>
                    <div class="countdown__item">
                      <p>--{{ 'general.date.h' | t }}</p>
                    </div>
                    <div class="countdown__item">
                      <p>--{{ 'general.date.m' | t }}</p>
                    </div>
                    <div class="countdown__item">
                      <p>--{{ 'general.date.s' | t }}</p>
                    </div>
                  </countdown-timer>
                </div>
              </div>
            </div>
          {%- endif -%}
        {%- endif -%}
      </div>
    {%- else -%}
      <div class="product-card__media h-auto overflow-hidden">
        <span class="block aspect-{{ image_ratio }}"></span>
      </div>
    {%- endif -%}
    <product-bundle-info
      class="product-card__content grow flex flex-col{% if featured_media %} justify-start text-{{ settings.card_text_alignment }}{% else %} justify-center items-center absolute top-0 left-0 w-full h-full{% endif %}"
      data-section-id="{{ section_id }}"
      data-product-id="{{ product_id }}"
      data-product-url="{{ product.url }}"
      data-update-url="false"
    >
      
      {%- if show_vendor -%}
        <div class="product-card__top w-full">
          <span class="sr-only">{{ 'general.accessibility.vendor' | t }}</span>
          {{- product.vendor | link_to_vendor : class: "caption reversed-link uppercase leading-none tracking-widest" -}}
        </div>
      {%- endif -%}

      <div class="product-card__details flex flex-col items-baseline gap-2 w-full">
        <p class="grow">
          <a class="product-card__title reversed-link text-base-xl font-medium leading-tight" href="{{ product_url }}" data-product-bundle-title>
            {{- product.title | escape -}}
          </a>
        </p>
        {% comment %} <div id="Price-{{ section_id }}-{{ product_id }}">
          {%- render 'product-price', product: product, use_variant: true, class: 'flex flex-wrap lg:items-end gap-2 md:gap-1d5', skip_to_price: true -%}
        </div> {% endcomment %}
      </div>

      <div class="product-card__variants grow">
        {%- render 'product-bundle-variant-picker',
          product: product,
          product_id: product_id,
          section_id: section_id,
          show_variant_labels: show_variant_labels,
          picker_type: picker_type,
          enable_color_swatches: enable_color_swatches,
          color_swatch_type: color_swatch_type,
          controls: controls
        -%}
      </div>
    </product-bundle-info>
  </div>
{%- else -%}
  {%- render 'product-card-placeholder', placeholder: 'image', image_ratio: image_ratio, text_alignment: text_alignment, show_vendor: show_vendor, show_rating: show_rating -%}
{%- endif -%}
